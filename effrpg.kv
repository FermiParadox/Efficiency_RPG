#:kivy 1.9.1

#:import main main
#:import App kivy.app


<Label>:
    markup: True
    color: 0,0,0,1

<MyProgressBar>:
    max: 1
    value: 0

    limited_value: min(self.value, self.max)
    # Filled ratio should never be 0 or 1
    # otherwise it would cause size_hints equal to 0,
    # that is, None-type value, resulting in ignoring size_hint
    filled_ratio: max(.00001, min(.9999, float(self.value) / self.max))
    empty_ratio: 1-self.filled_ratio
    filled_color: 0,1,0,1
    empty_color: 1,0,0,1

    size_hint_y: .5
    pos_hint: {'center_x': .5, 'center_y': .5}
    canvas.before:
        Color:
            rgba: root.filled_color
        Rectangle:
            size: root.width * root.filled_ratio, root.height
            pos: root.pos
        Color:
            rgba: root.empty_color
        Rectangle:
            size: root.width * root.empty_ratio, root.height
            pos: root.x + root.width*root.filled_ratio, root.y


<VersionLabel@Label>:
    pos_hint: {'center_x': .8, 'center_y': .07}
    size_hint: .9, .2

    text: '{} {}'.format('version', main.__version__)
    font_size: '12sp'



<SubjectBar>:
    subj_dicts_changed: app.subj_dicts_changed
    max: 1
    on_subj_dicts_changed: self.subj_dict = getattr(app, self.subj.name())
    value: sum(self.subj_dict[a][0] for a in self.subj_dict)

<SubjectBarBox>:
    orientation: 'horizontal'

    Image:
        size_hint_x: .25
        source: root.image_path
    SubjectBar:
        subj: root.subj

<SubjectsBarsBox>:
    orientation: 'vertical'


<ActionsSlide@BoxLayout>:
    orientation: 'vertical'



<TodayPage>:
    direction: 'bottom'


<MainWidget>:
    id: main_widg

    canvas.before:
        Color:
            rgba: .8,.8,.8,1
        Rectangle:
            pos: self.pos
            size: self.size

    FloatLayout:
        VersionLabel
        Label:
            pos_hint: {'center_x': .5, 'center_y': .8}
            size_hint: .9, .1
            text: main.APP_NAME
            font_size: '30sp'
        BoxLayout:
            pos_hint: {'center_x': .5, 'center_y': .5}
            size_hint: .5, .35
            orientation: 'vertical'

            Button:
                text: 'Today'
                bold: True
                on_release: root.load_slide(today_page)
            Button:
                text: 'Calendar'
                bold: True
                on_release: root.load_slide(rewards_page)
            Button:
                text: 'About'
                on_release: root.load_slide(about_page)
            Button:
                text: 'Citations'
                on_release: root.load_slide(citations_page)
    TodayPage:
        id: today_page

        SubjectsBarsBox
        SubjectSelectionSlide
            id: subj_selection_slide
        ActionsSlide:
            SubjectBarBox:
                subj: subj_selection_slide.subj
                size_hint_y: .3
            ActionsGrid:
                id: actions_grid
                size_hint_y: .7
                subj: subj_selection_slide.subj
                on_subj: self.populate_grid()
            ActionTimesBox
                id: action_times_box
                orientation: 'vertical'
                minutes_box: minutes_box
                hours_box: hours_box
                action: actions_grid.action
                on_action: self.set_times_lists()
                subj: subj_selection_slide.subj
                on_subj: self.reset_times_lists()

                Label:
                    text: action_times_box.description
                    size_hint_y: .3
                TimesButtonsBox:
                    id: minutes_box
                    size_hint_y: .3
                    measuring_unit: "'"
                    times_seq: action_times_box.minutes_lst
                TimesButtonsBox:
                    id: hours_box
                    size_hint_y: .4
                    measuring_unit: 'h'
                    times_seq: action_times_box.hours_lst
                BoxLayout:
                    size_hint_y: .2
                    Label:
                        hours: int(confirm_button.time_added)
                        minutes: int((confirm_button.time_added - self.hours) * 60)
                        text: "Extra time: {}h {}'".format(self.hours, self.minutes)
                    ButtonD:
                        id: confirm_button
                        text: 'ok'
                        time_added: minutes_box.time_added + hours_box.time_added
                        on_release: app.modify_action(subj=subj_selection_slide.subj, act=action_times_box.action, time_added=self.time_added)
                        on_release: minutes_box.reset_time_added(time=.3)
                        on_release: hours_box.reset_time_added(time=.3)
                        on_release: self.disable_for(.53)
                    ButtonD:
                        text: 'cancel'
                        on_release: minutes_box.reset_time_added(time=.1)
                        on_release: hours_box.reset_time_added(time=.1)



# PASTE-TEMPLATE
# (copy canvas for debugging)
<RedLabel@Label>:
    canvas.before:
        Color:
            rgba: 1,0,.0,1
        Rectangle:
            pos: self.pos
            size: self.size