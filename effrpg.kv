#:kivy 1.9.1

#:import main main
#:import App kivy.app


<Label>:
    markup: True
    color: 0,0,0,1

<Button>:
    background_normal: 'own_images/simple_grey_button.png'
    background_down: 'own_images/simple_grey_button_pressed.png'
    background_disabled_normal: self.background_down

<ConfinedTextLabel>:
    color: 0,0,0,1
    text_size: self.width * .8, None
    size_hint_y: None
    height: self.texture_size[1]

<MyProgressBar>:
    max: 1
    value: 0

    limited_value: min(self.value, self.max)
    # Filled ratio should never be 0 or 1
    # otherwise it would cause size_hints equal to 0,
    # that is, None-type value, resulting in ignoring size_hint
    filled_ratio: max(.00001, min(.9999, float(self.value) / self.max))
    empty_ratio: 1-self.filled_ratio

    size_hint_y: .5
    pos_hint: {'center_x': .5, 'center_y': .5}
    canvas.before:
        Color:
            rgba: root.filled_color
        Rectangle:
            size: root.width * root.filled_ratio, root.height
            pos: root.pos
        Color:
            rgba: root.empty_color
        Rectangle:
            size: root.width * root.empty_ratio, root.height
            pos: root.x + root.width*root.filled_ratio, root.y


<VersionLabel@Label>:
    pos_hint: {'center_x': .8, 'center_y': .07}
    size_hint: .9, .2

    text: '{} {}'.format('version', main.__version__)
    font_size: '12sp'



<SubjectBar>:
    subj_dicts_changed: app.subj_dicts_changed
    max: 1
    on_subj:
        if self.subj.FILLER: self.empty_color = (.2,.2,.2,1); self.filled_color = (0,.4,0,1)
        else: self.empty_color = self.DEFAULT_EMPTY_COLOR; self.filled_color = self.DEFAULT_FILLED_COLOR
    on_subj_dicts_changed: self.subj_dict = getattr(app, self.subj.name())
    on_subj_dicts_changed: self.value = app.subj_goal_ratio_and_time(subj=self.subj)[0]
    value: app.subj_goal_ratio_and_time(subj=self.subj)[0]
    on_subj: self.subj_dict = getattr(app, self.subj.name())


<SubjectBarBox>:
    orientation: 'horizontal'

    Image:
        size_hint_x: .25
        source: root.image_path
    SubjectBar:
        subj: root.subj

<SubjectsBarsBox>:
    orientation: 'vertical'


<ActionsSlide@BoxLayout>:
    orientation: 'vertical'

<FocusBox@BoxLayout>:
    Image:
        source: main.image_path(im_name='aim.png')
    FocusButton:
        text: '{}%'.format(self.focus_percent)
        on_text: app.focus_percent


<TodayPage>:
    direction: 'bottom'


<MainWidget>:
    id: main_widg

    canvas.before:
        Color:
            rgba: .8,.8,.8,1
        Rectangle:
            pos: self.pos
            size: self.size

    FloatLayout:
        VersionLabel
        Label:
            pos_hint: {'center_x': .5, 'center_y': .8}
            size_hint: .9, .1
            text: main.APP_NAME
            font_size: '30sp'
        BoxLayout:
            pos_hint: {'center_x': .5, 'center_y': .5}
            size_hint: .5, .35
            orientation: 'vertical'

            Button:
                text: 'Today'
                bold: True
                on_release: root.load_slide(today_page)
            Button:
                text: 'Calendar'
                bold: True
                on_release: root.load_slide(rewards_page)
            Button:
                text: 'About'
                on_release: root.load_slide(about_page)
            Button:
                text: 'Citations'
                on_release: root.load_slide(citations_page)
    TodayPage:
        id: today_page

        BoxLayout:
            orientation: 'vertical'
            SubjectsBarsBox
            FocusBox
                size_hint_y: .2
            Label:
                size_hint_y: .2
                subj_dicts_changed: app.subj_dicts_changed
                bold: True
                text: 'Goals: {:.0%} \nWork hours: {:.1f}'.format(*app.daily_goal_ratio_and_time())
                on_subj_dicts_changed: self.text = 'Goals: {:.0%} \nWork hours: {:.1f}'.format(*app.daily_goal_ratio_and_time())
                text_size: self.size
                halign: 'center'
                valign: 'middle'
        SubjectSelectionSlide
            id: subj_selection_slide
        ActionsSlide:
            SubjectBarBox:
                subj: subj_selection_slide.subj
                size_hint_y: .3
            ActionsGrid:
                id: actions_grid
                size_hint_y: .7
                subj: subj_selection_slide.subj
                on_subj: self.populate_grid()
            ActionTimesBox
                id: action_times_box
                orientation: 'vertical'
                minutes_box: minutes_box
                hours_box: hours_box
                action: actions_grid.action
                on_action: self.set_times_lists()
                subj: subj_selection_slide.subj
                on_subj: self.reset_times_lists()

                Label:
                    text: action_times_box.description
                    size_hint_y: .3
                TimesButtonsBox:
                    id: minutes_box
                    size_hint_y: .3
                    measuring_unit: "'"
                    times_seq: action_times_box.minutes_lst
                TimesButtonsBox:
                    id: hours_box
                    size_hint_y: .4
                    measuring_unit: 'h'
                    times_seq: action_times_box.hours_lst
                BoxLayout:
                    size_hint_y: .2
                    Label:
                        hours: int(confirm_button.time_added)
                        minutes: int((confirm_button.time_added - self.hours) * 60)
                        bold: True
                        text: "+{}:{:0<2}".format(self.hours, self.minutes)
                    ButtonD:
                        size_hint_y: .8
                        id: confirm_button
                        text: 'ok'
                        time_added: minutes_box.time_added + hours_box.time_added
                        on_release: app.modify_action(subj=subj_selection_slide.subj, act=action_times_box.action, time_added=self.time_added)
                        on_release: minutes_box.reset_time_added(time=.3)
                        on_release: hours_box.reset_time_added(time=.3)
                        on_release: self.disable_for(.53)
                    ButtonD:
                        size_hint_y: .8
                        text: 'cancel'
                        on_release: minutes_box.reset_time_added(time=.1)
                        on_release: hours_box.reset_time_added(time=.1)
    CitationsBox:
        id: citations_page



# PASTE-TEMPLATE
# (copy canvas for debugging)
<RedLabel@Label>:
    canvas.before:
        Color:
            rgba: 1,0,.0,1
        Rectangle:
            pos: self.pos
            size: self.size